<!doctype html><meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>HEY KAVA – ETA / ルート</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{--bg:#f7fbfb;--fg:#0b1f2a;--card:#fff;--acc:#0a84ff}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Sans","Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:960px;margin:0 auto;padding:14px}
  h1{font-size:1.2rem;margin:8px 0 12px}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin:8px 0 12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{border:1px solid #e3eef2;border-radius:999px;padding:8px 14px;background:#fff}
  .btn{background:#fff;border:1px solid #dbe8ee;border-radius:12px;padding:8px 12px}
  .btn.primary{background:var(--acc);color:#fff;border-color:var(--acc)}
  #map{height:60vh;border-radius:14px;overflow:hidden}
  .input{display:flex;gap:8px;align-items:center;background:#fff;border:1px solid #dbe8ee;border-radius:12px;padding:8px 10px;flex:1}
  .input input{border:none;outline:none;font-size:16px;flex:1}
  .muted{color:#5a7382;font-size:.92rem}
  .stat{font-weight:600}
  .hide{display:none!important}
</style>

<div class="wrap">
  <div class="row">
    <div class="pill">
      モード：
      <label style="margin-left:6px"><input type="radio" name="mode" value="toDest" checked> 行き先入力</label>
      <label style="margin-left:10px"><input type="radio" name="mode" value="kavaToMe"> カバ→私</label>
    </div>
    <div class="pill"><label><input type="radio" name="profile" value="foot"> 徒歩</label></div>
    <div class="pill"><label><input type="radio" name="profile" value="driving" checked> 車</label></div>
    <button class="btn" id="locBtn">現在地ON</button>
  </div>

  <!-- 行き先入力モードのUI -->
  <div class="card" id="destBox">
    <div class="row">
      <div class="input">
        <input id="searchBox" placeholder="行き先を入力（例：川崎駅、ネイル 渋谷）">
        <button class="btn" id="searchBtn">検索</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px">
      ※ 上に店名/住所を入れて「検索」。現在地→行き先のETA/ルートを表示します。
    </div>
  </div>

  <!-- カバ→私モードのUI -->
  <div class="card hide" id="kavaBox">
    <div class="row">
      <button class="btn" id="kavaModeBtn">カバ側モードON（自分が運転手）</button>
      <button class="btn" id="copyLinkBtn">リンクをコピー</button>
    </div>
    <div class="muted" style="margin-top:6px">
      カバ側：上の「カバ側モードON」で現在地をURLの <b>kava=緯度,経度</b> に入れ、相手へURLを送ってください。<br>
      見る側：このページを開くだけで「カバ→私」のETAが出ます。<br>
      （※サーバー無しのため完全ライブ追跡ではありません。位置が変わったら新しいリンクを送ってください）
    </div>
  </div>

  <div class="row" style="margin:6px 0 10px">
    距離：<span class="stat" id="dist">–</span> km　|　到着予測：<span class="stat" id="eta">–:–</span><span id="etaMin"></span>
  </div>

  <div id="map" class="card"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const $ = s=>document.querySelector(s);
let me=null, dest=null, kava=null;
let youMarker=null, destMarker=null, kavaMarker=null, routeLine=null;
let profile="driving";        // "driving" or "foot"
let mode   ="toDest";         // "toDest" or "kavaToMe"

// 地図
const map = L.map('map',{zoomControl:true}).setView([35.680,139.769], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
const youIcon  = L.icon({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                         shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'});
const blueDot = L.divIcon({className:'', html:'<div style="width:18px;height:18px;background:#0a84ff;border:2px solid #fff;border-radius:50%"></div>'});
const greenDot= L.divIcon({className:'', html:'<div style="width:18px;height:18px;background:#27ae60;border:2px solid #fff;border-radius:50%"></div>'});

// 現在地取得
async function getMe(auto=false){
  try{
    const pos = await new Promise((res,rej)=>{
      navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:10000});
    });
    me = [pos.coords.latitude, pos.coords.longitude];
    if(!youMarker) youMarker = L.marker(me,{icon:youIcon}).addTo(map).bindPopup("あなたの現在地");
    else youMarker.setLatLng(me);
    if(!dest && !kava) map.setView(me, 14);
    updateRoute();
  }catch(e){ if(!auto) alert("位置情報が取得できませんでした"); }
}

// ルート描画
async function updateRoute(){
  // A: 行き先入力 = me -> dest
  if(mode==="toDest" && me && dest){
    await routeAndPaint(me,dest);
  }
  // B: カバ→私 = kava -> me
  if(mode==="kavaToMe" && kava && me){
    await routeAndPaint(kava, me);
  }
}

async function routeAndPaint(a,b){
  const url = `https://router.project-osrm.org/route/v1/${profile}/${a[1]},${a[0]};${b[1]},${b[0]}?overview=full&geometries=geojson`;
  const j = await fetch(url).then(r=>r.json()).catch(()=>null);
  if(!j || !j.routes || !j.routes[0]) return;
  const {distance,duration,geometry} = j.routes[0];
  $("#dist").textContent = (distance/1000).toFixed(2);
  const etaDate = new Date(Date.now()+duration*1000);
  $("#eta").textContent = etaDate.toTimeString().slice(0,5);
  $("#etaMin").textContent = `（約${Math.round(duration/60)}分）`;
  if(routeLine) map.removeLayer(routeLine);
  routeLine = L.geoJSON(geometry,{style:{color:"#0a84ff",weight:5}}).addTo(map);
  map.fitBounds(L.latLngBounds([a,b]).pad(0.25));
}

// Nominatim 検索 → dest セット
async function geocode(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
  const d = await fetch(url,{headers:{'Accept':'application/json'}}).then(r=>r.json()).catch(()=>null);
  if(!d || !d[0]){ alert("見つかりませんでした"); return; }
  const {lat,lon,display_name} = d[0];
  dest = [parseFloat(lat), parseFloat(lon)];
  if(!destMarker) destMarker=L.marker(dest,{icon:greenDot}).addTo(map).bindPopup("行き先："+display_name.split(",")[0]);
  else destMarker.setLatLng(dest).getPopup()?.setContent("行き先："+display_name.split(",")[0]);
  updateRoute();
}

// クエリ取得/設定
function getQuery(){ return new URLSearchParams(location.search); }
function setQuery(obj){
  const p = getQuery();
  Object.entries(obj).forEach(([k,v])=>{ if(v==null) p.delete(k); else p.set(k,v); });
  history.replaceState(null,"",location.pathname+"?"+p.toString());
}

// カバ側モード：自分の現在地を kava=lat,lng でURLに入れる
async function setKavaFromHere(){
  try{
    const pos = await new Promise((res,rej)=>{
      navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:10000});
    });
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    setQuery({kava:`${lat},${lng}`, t:Date.now()}); // tはおまけ
    kava = [parseFloat(lat), parseFloat(lng)];
    if(!kavaMarker) kavaMarker=L.marker(kava,{icon:blueDot}).addTo(map).bindPopup("カバの位置");
    else kavaMarker.setLatLng(kava);
    map.setView(kava, 14);
    updateRoute();
  }catch(e){ alert("カバの位置が取得できませんでした"); }
}

// クリップボードコピー
async function copyLink(){
  try{ await navigator.clipboard.writeText(location.href); alert("リンクをコピーしました"); }
  catch{ prompt("コピーしてください↓", location.href); }
}

// UIイベント
$("#locBtn").onclick = ()=>getMe(false);
$("#searchBtn").onclick = ()=>{ const q=$("#searchBox").value.trim(); if(q) geocode(q); };
$("#kavaModeBtn").onclick = setKavaFromHere;
$("#copyLinkBtn").onclick = copyLink;
document.querySelectorAll('input[name="profile"]').forEach(r=>r.addEventListener("change",(e)=>{profile=e.target.value; updateRoute();}));
document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener("change",(e)=>{
  mode = e.target.value;
  $("#destBox").classList.toggle("hide", mode!=="toDest");
  $("#kavaBox").classList.toggle("hide", mode!=="kavaToMe");
  updateRoute();
}));

// 起動処理
window.addEventListener('load', ()=>{
  // クエリに kava があればセット
  const q = getQuery().get("kava");
  if(q){
    const [la,ln] = q.split(",").map(parseFloat);
    if(Number.isFinite(la)&&Number.isFinite(ln)){
      kava=[la,ln];
      if(!kavaMarker) kavaMarker=L.marker(kava,{icon:blueDot}).addTo(map).bindPopup("カバの位置");
      else kavaMarker.setLatLng(kava);
      // 見る側に分かりやすいよう「カバ→私」をアクティブに
      document.querySelector('input[name="mode"][value="kavaToMe"]').checked=true;
      mode="kavaToMe";
      $("#destBox").classList.add("hide");
      $("#kavaBox").classList.remove("hide");
      map.setView(kava, 14);
    }
  }
  // 自動で現在地請求
  getMe(true);
});
</script>